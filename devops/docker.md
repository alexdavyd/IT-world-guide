# Docker: подробное руководство

## Содержание
1. [Что такое Docker?](#что-такое-docker)
2. [Основные понятия](#основные-понятия)
3. [Архитектура Docker](#архитектура-docker)
4. [Установка Docker](#установка-docker)
5. [Основные команды Docker](#основные-команды-docker)
6. [Dockerfile: создание собственных образов](#dockerfile-создание-собственных-образов)
7. [Управление образами](#управление-образами)
8. [Управление контейнерами](#управление-контейнерами)
9. [Сети в Docker](#сети-в-docker)
10. [Хранение данных: volumes и bind mounts](#хранение-данных-volumes-и-bind-mounts)
11. [Docker Compose: оркестрация многоконтейнерных приложений](#docker-compose-оркестрация-многоконтейнерных-приложений)
12. [Docker Registry](#docker-registry)
13. [Docker в CI/CD](#docker-в-cicd)
14. [Безопасность Docker](#безопасность-docker)
15. [Мониторинг и логирование](#мониторинг-и-логирование)
16. [Производительность и ограничения ресурсов](#производительность-и-ограничения-ресурсов)
17. [Экосистема Docker](#экосистема-docker)
18. [Типичные проблемы и антипаттерны](#типичные-проблемы-и-антипаттерны)
19. [Заключение](#заключение)
20. [Связанные разделы репозитория](#связанные-разделы-репозитория)

---

## Что такое Docker?

**Docker** — это платформа для разработки, доставки и запуска приложений в контейнерах. Контейнеры позволяют упаковать приложение со всеми его зависимостями (библиотеки, настройки, системные утилиты) в изолированную среду, которая гарантированно будет работать одинаково на любой системе, поддерживающей Docker.

### Контейнеры vs виртуальные машины

| Характеристика       | Контейнеры (Docker)                          | Виртуальные машины                           |
| -------------------- | --------------------------------------------- | --------------------------------------------- |
| **Уровень изоляции** | Изоляция на уровне процессов (использует ядро хоста) | Полная изоляция с собственной ОС (гипервизор) |
| **Размер**           | Мегабайты (образ содержит только приложение + зависимости) | Гигабайты (образ включает всю ОС)            |
| **Запуск**           | Секунды                                       | Минуты                                        |
| **Использование ресурсов** | Эффективное, разделяет ядро хоста            | Требует выделения ресурсов для каждой ВМ      |
| **Переносимость**    | Высокая (любая система с Docker)              | Зависит от формата и гипервизора              |

---

## Основные понятия

- **Образ (Image)** — неизменяемый шаблон для создания контейнеров. Содержит код, зависимости, настройки. Образы собираются из Dockerfile и хранятся в реестре.
- **Контейнер (Container)** — запущенный экземпляр образа. Изолированное окружение для выполнения приложения.
- **Dockerfile** — текстовый файл с инструкциями по сборке образа.
- **Реестр (Registry)** — хранилище образов (публичное — Docker Hub, приватное — Nexus, Artifactory, AWS ECR).
- **Том (Volume)** — механизм для постоянного хранения данных, переживающих перезапуск контейнера.
- **Сеть (Network)** — способ взаимодействия контейнеров между собой и с внешним миром.

---

## Архитектура Docker

Docker использует клиент-серверную архитектуру:

- **Docker Client** — интерфейс командной строки (`docker`), отправляет команды демону.
- **Docker Daemon (`dockerd`)** — фоновый процесс, управляет объектами Docker (образы, контейнеры, сети, тома).
- **containerd** — компонент, управляющий жизненным циклом контейнеров (высокоуровневый рантайм).
- **runc** — низкоуровневый рантайм, создающий и запускает контейнеры (соответствует спецификациям OCI).

Схема:

```
+----------------+         +----------------+
| Docker Client  |  --->   | Docker Daemon  |
| (docker CLI)   |         | (dockerd)      |
+----------------+         +----------------+
                                   |
                                   v
                           +----------------+
                           |   containerd   |
                           +----------------+
                                   |
                                   v
                           +----------------+
                           |     runc       |
                           +----------------+
```

---

## Установка Docker

### На Linux (Ubuntu/Debian)
```bash
sudo apt update
sudo apt install docker.io
sudo systemctl start docker
sudo systemctl enable docker
```

### На macOS
Скачать Docker Desktop с [официального сайта](https://www.docker.com/products/docker-desktop).

### На Windows
Установить Docker Desktop (требуется WSL2 или Hyper-V).

После установки проверить:
```bash
docker --version
docker run hello-world
```

---

## Основные команды Docker

### Работа с образами
| Команда                          | Описание                                    |
| -------------------------------- | ------------------------------------------- |
| `docker pull <image>:<tag>`      | Скачать образ из реестра                    |
| `docker images`                  | Список локальных образов                     |
| `docker rmi <image>`             | Удалить образ                                |
| `docker build -t <name>:<tag> .` | Собрать образ из Dockerfile в текущей папке  |
| `docker tag <image> <new_name>`  | Присвоить тег существующему образу           |
| `docker push <image>`            | Загрузить образ в реестр                     |

### Работа с контейнерами
| Команда                                       | Описание                                         |
| --------------------------------------------- | ------------------------------------------------ |
| `docker run <image>`                          | Создать и запустить контейнер из образа          |
| `docker run -d --name <name> <image>`         | Запустить в фоне с именем                        |
| `docker run -it <image> /bin/bash`            | Запустить интерактивно (войти в контейнер)       |
| `docker ps`                                   | Список запущенных контейнеров                     |
| `docker ps -a`                                | Список всех контейнеров (включая остановленные)  |
| `docker stop <container>`                      | Остановить контейнер                              |
| `docker start <container>`                     | Запустить остановленный контейнер                 |
| `docker restart <container>`                   | Перезапустить контейнер                           |
| `docker rm <container>`                        | Удалить контейнер                                 |
| `docker logs <container>`                      | Показать логи контейнера                          |
| `docker exec -it <container> <command>`        | Выполнить команду внутри работающего контейнера   |
| `docker cp <src> <container>:<dest>`           | Скопировать файлы в контейнер/из контейнера       |
| `docker inspect <container>`                   | Подробная информация о контейнере                 |

### Управление ресурсами
| Команда                       | Описание                            |
| ----------------------------- | ----------------------------------- |
| `docker system df`            | Показать использование диска        |
| `docker system prune`         | Удалить неиспользуемые объекты      |
| `docker volume ls`            | Список томов                        |
| `docker network ls`           | Список сетей                        |

---

## Dockerfile: создание собственных образов

Dockerfile содержит инструкции для сборки образа. Пример для простого Python-приложения:

```dockerfile
# Базовый образ
FROM python:3.11-slim

# Установка зависимостей
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Копирование исходного кода
COPY . .

# Команда по умолчанию
CMD ["python", "app.py"]
```

### Основные инструкции

| Инструкция  | Описание                                                                 |
| ----------- | ------------------------------------------------------------------------ |
| `FROM`      | Задаёт базовый образ (обязательно)                                       |
| `RUN`       | Выполняет команду в процессе сборки (например, установка пакетов)        |
| `COPY`      | Копирует файлы из контекста сборки в образ                               |
| `ADD`       | Аналогично COPY, но умеет распаковывать архивы и загружать по URL        |
| `WORKDIR`   | Устанавливает рабочую директорию для последующих инструкций              |
| `ENV`       | Задаёт переменные окружения                                              |
| `EXPOSE`    | Указывает порт, который будет слушать контейнер (информационно)          |
| `CMD`       | Команда по умолчанию при запуске контейнера (может быть переопределена)  |
| `ENTRYPOINT`| То же, но с фиксированными аргументами (сложнее переопределить)          |
| `VOLUME`    | Создаёт точку монтирования для томов                                     |
| `USER`      | Переключает пользователя (рекомендуется не использовать root)            |
| `ARG`       | Переменная, доступная только во время сборки                             |

### Многоступенчатая сборка (multi-stage)
Позволяет уменьшить размер итогового образа, используя промежуточные образы для сборки.

```dockerfile
# Этап сборки
FROM golang:1.20 AS builder
WORKDIR /app
COPY . .
RUN go build -o myapp

# Финальный этап
FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/myapp .
CMD ["./myapp"]
```

---

## Управление образами

- **Слои (layers):** Каждая инструкция в Dockerfile создаёт слой. Слои кэшируются и переиспользуются.
- **Теги:** `image:tag` (если tag не указан, используется `latest`).
- **История:** `docker history <image>` показывает слои образа.
- **Сохранение/загрузка:** `docker save -o file.tar image` и `docker load -i file.tar` для переноса образов без реестра.

---

## Управление контейнерами

### Жизненный цикл
```
Created → Running → Paused → Stopped → Deleted
   ↑         ↓         ↓         ↓
   └─────────┴─────────┴─────────┘
```

### Полезные флаги `docker run`
- `-d` — запуск в фоне (detached).
- `-p host:container` — проброс портов (например, `-p 8080:80`).
- `-v host:container` — монтирование директории или тома.
- `--name` — задать имя контейнера.
- `--rm` — автоматически удалить контейнер после остановки.
- `--restart` — политика перезапуска (no, on-failure, always).
- `-e KEY=VALUE` — передать переменную окружения.
- `--network` — подключить к определённой сети.

### Пример запуска веб-сервера nginx
```bash
docker run -d --name web -p 80:80 nginx
```

---

## Сети в Docker

### Типы сетей

| Драйвер     | Описание                                                                 |
| ----------- | ------------------------------------------------------------------------ |
| `bridge`    | Изолированная сеть на хосте (по умолчанию). Контейнеры видят друг друга по IP. |
| `host`      | Контейнер использует сетевой стек хоста (без изоляции).                 |
| `none`      | Сеть отключена.                                                          |
| `overlay`   | Для связи контейнеров на разных хостах (в Swarm).                       |
| `macvlan`   | Контейнеру назначается MAC-адрес, выглядит как физическое устройство.   |

### Основные команды
```bash
docker network create mynet               # создать пользовательскую сеть
docker network ls                         # список сетей
docker network connect mynet container    # подключить контейнер к сети
docker network disconnect mynet container # отключить
docker network inspect mynet              # детали сети
```

### Взаимодействие контейнеров
В пользовательской bridge-сети контейнеры могут обращаться друг к другу по именам (DNS).  
Пример:
```bash
docker network create appnet
docker run -d --name db --network appnet postgres
docker run -d --name web --network appnet -p 80:80 myapp
```
В контейнере `web` можно обратиться к `db:5432`.

---

## Хранение данных: volumes и bind mounts

Данные в контейнере эфемерны — при удалении контейнера они теряются. Для постоянства используются volumes и bind mounts.

| Метод          | Описание                                                                 | Команда                                     |
| -------------- | ------------------------------------------------------------------------ | ------------------------------------------- |
| **Volume**     | Управляется Docker, хранится в `/var/lib/docker/volumes/`. Рекомендуется. | `docker volume create myvol`<br>`-v myvol:/data` |
| **Bind mount** | Монтирует конкретную папку хоста в контейнер.                           | `-v /host/path:/container/path`             |
| **tmpfs**      | Временное хранилище в памяти (только Linux).                            | `--tmpfs /container/path`                    |

### Пример с volume
```bash
docker volume create pgdata
docker run -d --name postgres -v pgdata:/var/lib/postgresql/data postgres
```

### Пример с bind mount (для разработки)
```bash
docker run -d --name dev -v $(pwd)/src:/app/src myapp
```

---

## Docker Compose: оркестрация многоконтейнерных приложений

Docker Compose позволяет описывать и запускать многоконтейнерные приложения с помощью YAML-файла.

### Пример `docker-compose.yml` для веб-приложения + БД
```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "5000:5000"
    environment:
      - DB_HOST=db
      - DB_USER=postgres
      - DB_PASSWORD=secret
    depends_on:
      - db

  db:
    image: postgres:15
    environment:
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=mydb
    volumes:
      - pgdata:/var/lib/postgresql/data

volumes:
  pgdata:
```

### Основные команды
```bash
docker-compose up -d        # запустить все сервисы в фоне
docker-compose down         # остановить и удалить контейнеры, сети
docker-compose logs -f      # смотреть логи
docker-compose ps           # список контейнеров
docker-compose exec web bash # войти в контейнер web
docker-compose build        # пересобрать образы
```

Compose автоматически создаёт изолированную сеть, где сервисы доступны по имени (как `web` и `db`).

---

## Docker Registry

Реестр хранит и раздаёт образы.

- **Docker Hub** — публичный реестр по умолчанию.
- **Приватный реестр** — можно запустить свой с помощью `docker run -d -p 5000:5000 --name registry registry:2`.
- **Аутентификация:** `docker login` для доступа к приватным репозиториям.
- **Тегирование для приватного реестра:** `docker tag myapp localhost:5000/myapp` и `docker push localhost:5000/myapp`.

---

## Docker в CI/CD

Docker активно используется в пайплайнах для:

- Сборки приложения в контейнере (единообразие окружения).
- Запуска тестов в изолированных контейнерах.
- Упаковки артефакта в Docker-образ.
- Развёртывания на серверах (образ загружается в реестр, затем разворачивается).

Пример этапа сборки в GitHub Actions:
```yaml
- name: Build and push Docker image
  uses: docker/build-push-action@v4
  with:
    push: true
    tags: myapp:${{ github.sha }}
```

---

## Безопасность Docker

### Рекомендации
- **Не запускай контейнеры от root.** Создавай пользователя в Dockerfile и используй `USER`.
- **Минимизируй размер образа:** используй alpine-версии, многоступенчатую сборку.
- **Сканируй образы на уязвимости:** `docker scan` (на основе Snyk) или Trivy.
- **Ограничивай ресурсы** (см. следующий раздел).
- **Не храни секреты в образах.** Используй переменные окружения или Docker secrets.
- **Используй read-only root filesystem** при запуске: `--read-only`.
- **Подписывай образы** (Docker Content Trust).

---

## Мониторинг и логирование

- **Логи:** `docker logs <container>` собирает stdout/stderr. Можно настроить драйверы логирования (json-file, syslog, fluentd и др.).
- **Статистика:** `docker stats` показывает использование CPU, памяти, сети.
- **События:** `docker events` — поток событий от демона (создание, остановка и т.д.).
- **Интеграция с системами мониторинга:** Prometheus, cAdvisor, Datadog.

---

## Производительность и ограничения ресурсов

Docker позволяет ограничивать ресурсы контейнера:

| Флаг                  | Описание                                    |
| --------------------- | ------------------------------------------- |
| `--cpus=<value>`      | Количество ядер CPU (например, `1.5`)       |
| `--memory=<value>`    | Лимит памяти (например, `512m`)             |
| `--memory-swap`       | Лимит swap (обычно равен memory)            |
| `--blkio-weight`      | Приоритет ввода-вывода                      |

Пример:
```bash
docker run -d --cpus=2 --memory=1g nginx
```

---

## Экосистема Docker

- **Docker Compose** — для локальной разработки.
- **Docker Swarm** — встроенная оркестрация (менее популярна, чем Kubernetes).
- **Kubernetes** — де-факто стандарт оркестрации, часто использует Docker как рантайм (через containerd).
- **Portainer** — веб-интерфейс для управления Docker.
- **Docker Desktop** — удобная среда для macOS/Windows с GUI.

---

## Типичные проблемы и антипаттерны

- **Запуск процессов от root** — угроза безопасности.
- **Толстые образы** — большой размер, долгая загрузка.
- **Отсутствие версионирования тегов** — использование `latest` в продакшене.
- **Игнорирование .dockerignore** — в образ попадают ненужные файлы.
- **Запуск нескольких процессов в одном контейнере** — лучше разделять.
- **Хранение данных в контейнере** — без volume данные пропадут.
- **Жёсткая привязка к IP-адресам** — лучше использовать имена сервисов.
- **Не ограничивать ресурсы** — один контейнер может «съесть» всю память хоста.

---

## Заключение

Docker стал стандартом упаковки и доставки приложений. Он упрощает разработку, тестирование и эксплуатацию, обеспечивая единообразие окружений. Освоив основные концепции и команды, вы сможете эффективно использовать контейнеры в повседневной работе. Дальнейшее углубление — изучение оркестрации (Kubernetes), оптимизации образов и продвинутых сценариев сети и безопасности.

---

## Связанные разделы репозитория

- [CI/CD: непрерывная интеграция и доставка](ci_cd.md) — как Docker встраивается в пайплайны.
- [Kubernetes: основы](kubernetes.md) — оркестрация контейнеров.
- [Linux: основные команды](../devops/linux/commands.md) — работа с хостовой ОС.
- [Сети и протоколы](../glossary/network.md) — сетевые концепции.
- [Безопасность](../glossary/security.md) — общие принципы безопасности.
