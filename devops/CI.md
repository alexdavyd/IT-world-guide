# Continuous Integration (CI): подробное руководство

## Содержание
1. [Что такое CI?](#что-такое-ci)
2. [Цели внедрения CI](#цели-внедрения-ci)
3. [Что входит в CI](#что-входит-в-ci)
   - [Система контроля версий](#система-контроля-версий)
   - [Автоматическая сборка](#автоматическая-сборка)
   - [Автоматическое тестирование](#автоматическое-тестирование)
   - [Анализ кода](#анализ-кода)
   - [Уведомления](#уведомления)
4. [Типовой CI-процесс](#типовой-ci-процесс)
5. [Примеры CI-пайплайнов](#примеры-ci-пайплайнов)
   - [Пример для Python (GitHub Actions)](#пример-для-python-github-actions)
   - [Пример для JavaScript (GitLab CI)](#пример-для-javascript-gitlab-ci)
6. [Схема CI](#схема-ci)
7. [Чем ограничивается CI](#чем-ограничивается-ci)
8. [Антипаттерны CI](#антипаттерны-ci)
9. [Связь с CD](#связь-с-cd)
10. [Инструменты CI](#инструменты-ci)
11. [Заключение](#заключение)

---

## Что такое CI?

**Continuous Integration (CI)** — это практика разработки, при которой разработчики часто (несколько раз в день) интегрируют свои изменения в основную ветку репозитория. Каждая интеграция автоматически проверяется: запускается сборка и выполняется набор тестов. Основная идея — обнаруживать конфликты и ошибки как можно раньше, пока они не разрослись.

CI не означает просто «запускать тесты». Это целый процесс, включающий:
- Частые коммиты в общую ветку.
- Автоматическую сборку проекта.
- Автоматическое выполнение различных видов тестов.
- Быструю обратную связь для разработчика.

---

## Цели внедрения CI

1. **Раннее обнаружение ошибок** – проблемы выявляются через минуты после коммита, а не через дни.
2. **Снижение рисков интеграции** – конфликты между ветками решаются постоянно, а не перед релизом.
3. **Ускорение разработки** – меньше времени тратится на ручное тестирование и отладку.
4. **Повышение качества кода** – автоматические проверки не дают «грязному» коду попасть в основную ветку.
5. **Прозрачность** – состояние проекта всегда видно: зелёный пайплайн означает, что всё работает.

---

## Что входит в CI

### Система контроля версий
- Центральный репозиторий (Git, Mercurial и т.д.).
- Ветка `main` (или `master`) — источник истины.
- Разработчики работают в короткоживущих ветках и часто делают pull request (или merge request).

### Автоматическая сборка
- Компиляция (для компилируемых языков).
- Установка зависимостей.
- Генерация артефактов (jar-файлы, Docker-образы, статические файлы).
- **Важно:** сборка должна быть воспроизводимой и быстрой.

### Автоматическое тестирование
Самый важный компонент CI. Включает разные уровни тестов:

| Тип тестов                       | Что проверяет                                 | Скорость      | Частота запуска           |
|----------------------------------|-----------------------------------------------|---------------|---------------------------|
| **Модульные (unit)**             | Отдельные функции, классы                     | Очень быстрые | На каждый коммит          |
| **Интеграционные**               | Взаимодействие между модулями, с БД, API      | Средние       | На каждый коммит или реже |
| **Функциональные**               | Поведение системы с точки зрения пользователя | Медленные     | На ночь или по требованию |
| **Линтеры и статический анализ** | Стиль кода, потенциальные ошибки              | Быстрые       | На каждый коммит          |
| **Тесты безопасности**           | Уязвимости в зависимостях, коде               | Средние       | Периодически              |
| **Тесты совместимости**          | Работа в разных окружениях (браузеры, ОС)     | Медленные     | При необходимости         |

В CI обычно включают быстрые тесты (модульные, линтеры), которые выполняются за несколько минут. Более медленные тесты могут запускаться отдельно (например, nightly builds) или параллельно.

### Анализ кода
- Статический анализ (SonarQube, ESLint, Pylint).
- Проверка покрытия кода тестами.
- Поиск уязвимостей в зависимостях (Snyk, Dependabot).

### Уведомления
- Результаты CI отправляются разработчикам (email, Slack, Telegram).
- Статус пайплайна отображается в репозитории (значки «проходит/не проходит»).

---

## Типовой CI-процесс

1. Разработчик создаёт ветку от `main` и вносит изменения.
2. Делает коммит и пуш в удалённый репозиторий.
3. CI-сервер обнаруживает изменения и запускает пайплайн.
4. Пайплайн выполняет:
   - Клонирование репозитория.
   - Установку зависимостей.
   - Сборку проекта.
   - Запуск линтеров.
   - Запуск модульных тестов.
   - (Опционально) интеграционные тесты.
   - (Опционально) анализ покрытия.
5. Результат (успех/неудача) отображается в интерфейсе CI и присылается уведомление.
6. Если все проверки пройдены, ветка может быть слита с `main` (при pull request). Если нет — разработчик исправляет ошибки.

---

## Примеры CI-пайплайнов

### Пример для Python (GitHub Actions)

```yaml
name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        pip install poetry
        poetry install
    - name: Lint with flake8
      run: poetry run flake8 .
    - name: Test with pytest
      run: poetry run pytest --cov=src tests/
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
```

Что здесь происходит:
- Пайплайн запускается на push в `main` и на pull request.
- Тестируется на трёх версиях Python.
- Устанавливаются зависимости через Poetry.
- Запускается линтер (flake8).
- Запускаются тесты с замером покрытия.
- Покрытие отправляется в Codecov.

### Пример для JavaScript (GitLab CI)

```yaml
image: node:16

stages:
  - install
  - lint
  - test

cache:
  paths:
    - node_modules/

install_dependencies:
  stage: install
  script:
    - npm ci
  artifacts:
    paths:
      - node_modules/

lint:
  stage: lint
  script:
    - npm run lint

test:
  stage: test
  script:
    - npm run test:ci
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
```

- Этапы: установка зависимостей, линтинг, тесты.
- Кэширование `node_modules` для ускорения.
- В тестах извлекается процент покрытия из отчёта.

---

## Схема CI

Ниже представлена типичная схема работы CI (текстовое описание + ASCII-арт для наглядности).

```
[Dev] -> git push -> [GitHub] -> trigger -> [CI Server (GitHub Actions)]
                                                 |
                                                 v
                                         +-------+-------+
                                         |   Пайплайн    |
                                         +-------+-------+
                                                 |
                    +----------------------------+----------------------------+
                    |                            |                            |
                    v                            v                            v
            [Checkout code]              [Install deps]                [Run linters]
                    |                            |                            |
                    +----------------------------+----------------------------+
                                                 |
                                                 v
                                        [Run unit tests]
                                                 |
                                                 v
                                        [Run integration tests]
                                                 |
                                                 v
                                        [Publish results]
                                                 |
                                                 v
                                        [Notification (Slack, email)]
```

Схема в более формальном виде:

```mermaid
graph LR
    A[Push code] --> B[CI Trigger]
    B --> C[Checkout]
    C --> D[Install Dependencies]
    D --> E[Lint]
    E --> F[Unit Tests]
    F --> G[Integration Tests]
    G --> H[Report Status]
    H --> I[Notification]
```

---

## Чем ограничивается CI

CI не решает всех проблем. Важно понимать его границы:

1. **CI не гарантирует отсутствие ошибок** – тесты могут быть неполными, а логика – не протестированной.
2. **CI требует хорошо написанных тестов** – без качественных тестов пайплайн бесполезен.
3. **CI не заменяет code review** – автоматические проверки дополняют, но не отменяют ручной анализ.
4. **CI может быть медленным** – если пайплайн долгий, разработчики перестанут ждать его завершения и начнут игнорировать красные билды.
5. **CI не занимается развёртыванием** – это задача CD (Continuous Delivery/Deployment).
6. **CI не обеспечивает безопасность окружения** – тесты выполняются в изолированной среде, которая может отличаться от продакшена.

---

## Антипаттерны CI

- **Слишком долгий пайплайн** – разработчики теряют концентрацию, начинают параллельно работать над другим, забывают о результатах.
- **Нестабильные тесты (flaky tests)** – тесты, которые иногда падают без причины, снижают доверие к CI.
- **Игнорирование красного пайплайна** – если команда не исправляет сломанный билд немедленно, CI теряет смысл.
- **Запуск всех тестов при каждом коммите** – очень медленно; лучше разделить на быстрые (pre-commit) и медленные (ночные).
- **Отсутствие уведомлений** – разработчик не узнаёт о проблеме вовремя.
- **Сборка только перед релизом** – это уже не CI, а традиционный подход.

---

## Связь с CD

CI является фундаментом для **Continuous Delivery (CD)**. После того как код протестирован в CI, он готов к развёртыванию. CD добавляет шаги:
- Автоматическое развёртывание на staging-окружение.
- Прогон дополнительных тестов (приёмочные, нагрузочные).
- Ручное утверждение (approval) перед выкаткой в продакшен (Continuous Delivery) или автоматический деплой (Continuous Deployment).

Без CI невозможно представить современный CD: если код не протестирован, его нельзя безопасно доставлять пользователям.

---

## Инструменты CI

Популярные CI-сервисы и self-hosted решения:

| Инструмент              | Тип              | Особенности                                             |
|-------------------------|------------------|---------------------------------------------------------|
| **GitHub Actions**      | Облачный (SaaS)  | Встроен в GitHub, бесплатно для open-source, YAML       |
| **GitLab CI**           | Облачный/On-prem | Встроен в GitLab, мощный, пайплайн как код              |
| **Jenkins**             | Self-hosted      | Гибкий, огромное количество плагинов, сложная настройка |
| **CircleCI**            | Облачный         | Простая конфигурация, хорошая производительность        |
| **Travis CI**           | Облачный         | Раньше популярен, сейчас ограничен бесплатный тариф     |
| **TeamCity**            | Self-hosted      | От JetBrains, мощный, удобный UI                        |
| **Azure Pipelines**     | Облачный         | Интеграция с Azure, YAML или визуальный редактор        |
| **Bitbucket Pipelines** | Облачный         | Встроен в Bitbucket, простой YAML                       |

Выбор зависит от размера команды, бюджета, требований к безопасности и предпочтений.

---

## Заключение

Continuous Integration — это не просто автоматизация сборки и тестов. Это дисциплина, которая требует от команды:
- Писать тесты.
- Часто интегрировать изменения.
- Быстро реагировать на сломанный пайплайн.

Внедрение CI окупается снижением количества багов, ускорением вывода фич и улучшением морального климата в команде (меньше стресса перед релизами). Начинать можно с простого: добавить линтер и модульные тесты на каждый коммит. Со временем пайплайн можно усложнять, добавляя интеграционные тесты, проверки безопасности и т.д.

Помните: **CI — это путь, а не конечная точка**. Постоянно улучшайте свои процессы, и ваша кодовая база будет здоровой, а команда — счастливой.

---

## Дополнительные материалы в репозитории
- [CI/CD: непрерывная интеграция и доставка](CI-CD.md)
- [Инструменты CI](ci_tools.md) (если есть)
- [Тестирование: виды и подходы](../tools/testing.md)
- [GitHub Actions: примеры и настройка](github_actions.md)