# Continuous Delivery и Continuous Deployment (CD): подробное руководство

## Содержание
1. [Что такое CD?](#что-такое-cd)
2. [Цели внедрения CD](#цели-внедрения-cd)
3. [Что входит в CD](#что-входит-в-cd)
   - [Управление артефактами](#управление-артефактами)
   - [Управление окружениями](#управление-окружениями)
   - [Автоматизация развёртывания](#автоматизация-развёртывания)
   - [Тестирование после развёртывания](#тестирование-после-развёртывания)
   - [Мониторинг и оповещение](#мониторинг-и-оповещение)
4. [Типовой CD-процесс](#типовой-cd-процесс)
5. [Continuous Delivery vs Continuous Deployment](#continuous-delivery-vs-continuous-deployment)
6. [Стратегии развёртывания](#стратегии-развёртывания)
7. [Примеры CD-пайплайнов](#примеры-cd-пайплайнов)
   - [Пример Continuous Delivery (GitHub Actions + ручное утверждение)](#пример-continuous-delivery-github-actions--ручное-утверждение)
   - [Пример Continuous Deployment (GitLab CI)](#пример-continuous-deployment-gitlab-ci)
8. [Схема CD](#схема-cd)
9. [Чем ограничивается CD](#чем-ограничивается-cd)
10. [Антипаттерны CD](#антипаттерны-cd)
11. [Связь с CI и DevOps](#связь-с-ci-и-devops)
12. [Инструменты CD](#инструменты-cd)
13. [Заключение](#заключение)

---

## Что такое CD?

**CD** — это расширение практики непрерывной интеграции (CI) на этапы доставки и развёртывания программного обеспечения. В зависимости контекста CD может означать:

- **Continuous Delivery (Непрерывная доставка)** — подход, при котором код после прохождения автоматических проверок всегда находится в состоянии, готовом к релизу. Решение о выкатке в продакшен принимается вручную (одним кликом).
- **Continuous Deployment (Непрерывное развёртывание)** — ещё более автоматизированный подход: каждое изменение, успешно прошедшее все стадии пайплайна, автоматически попадает в продакшен без участия человека.

Основная идея CD — сделать процесс доставки изменений предсказуемым, быстрым и надёжным, чтобы выпускать новые версии продукта часто и с минимальным риском.

---

## Цели внедрения CD

1. **Скорость вывода изменений** — время от коммита до попадания в продакшен сокращается до минут или часов.
2. **Снижение риска релиза** — частые небольшие изменения проще откатывать и легче обнаруживать проблемы.
3. **Автоматизация рутинных действий** — развёртывание перестаёт быть ручной операцией, уменьшается число ошибок.
4. **Обратная связь от пользователей** — фичи быстрее попадают к пользователям, можно быстрее проверять гипотезы.
5. **Предсказуемость и повторяемость** — процесс развёртывания стандартизирован, одинаков для всех сред.
6. **Удовлетворённость команды** — меньше стресса перед релизами, больше контроля.

---

## Что входит в CD

### Управление артефактами
- После успешной сборки в CI создаётся **артефакт** — неизменяемый пакет, готовый к развёртыванию (Docker-образ, JAR, ZIP, deb-пакет и т.д.).
- Артефакты хранятся в **реестре артефактов** (Docker Hub, Nexus, Artifactory, GitHub Container Registry) с уникальной версией (обычно тег коммита или семантическая версия).

### Управление окружениями
- Определяются среды, куда будет разворачиваться приложение: **development**, **staging**, **pre-production**, **production**.
- Каждая среда должна быть максимально похожа на продакшен (инфраструктура как код, одинаковые версии зависимостей).
- Доступ к средам может быть ограничен (например, staging доступен только внутри компании).

### Автоматизация развёртывания
- Процесс развёртывания описывается кодом (скрипты, Ansible, Terraform, Helm, Kubernetes manifests).
- Пайплайн CD автоматически выполняет развёртывание на целевые окружения после успешного прохождения тестов.
- Включает подготовку окружения (миграции БД, обновление конфигов, очистка кэша).

### Тестирование после развёртывания
Даже после всех предыдущих проверок необходимо убедиться, что приложение работает в реальном окружении. Используются:

| Тип тестов               | Цель                                                              |
| ------------------------ | ----------------------------------------------------------------- |
| **Smoke-тесты**          | Быстрая проверка, что приложение запустилось и отвечает на базовые запросы |
| **Приёмочные тесты**     | Проверка критичного функционала с точки зрения бизнеса           |
| **Нагрузочные тесты**    | (опционально) проверка производительности на staging              |
| **Canary-тесты**         | Сравнение метрик новой и старой версии при канареечном развёртывании |

### Мониторинг и оповещение
- После развёртывания включается усиленный мониторинг (логи, метрики, трейсы).
- Настраиваются оповещения об аномалиях (ошибки, падение производительности).
- При обнаружении проблем может автоматически сработать откат (rollback).

---

## Типовой CD-процесс

1. **CI завершён** — артефакт собран, тесты пройдены, артефакт загружен в реестр.
2. **Развёртывание на staging** (если используется):
   - Автоматически запускается deploy на staging-окружение.
   - Выполняются миграции БД (если есть).
   - Запускаются smoke-тесты на staging.
   - (Опционально) прогоняются более медленные тесты (интеграционные, E2E).
3. **Ручное утверждение** (для Continuous Delivery) — ответственный разработчик или QA проверяет staging и нажимает кнопку «Deploy to production».
4. **Развёртывание на production**:
   - Выполняется по одной из стратегий (rolling, blue-green, canary).
   - После деплоя — smoke-тесты на production.
   - Мониторинг в течение определённого времени (например, 10–30 минут).
5. **Откат (rollback)** в случае проблем — автоматический или по команде.

---

## Continuous Delivery vs Continuous Deployment

| Характеристика          | Continuous Delivery                                   | Continuous Deployment                                 |
| ----------------------- | ----------------------------------------------------- | ----------------------------------------------------- |
| **Автоматизация**       | До staging — полностью; до production — нужен ручной триггер | Полностью автоматический процесс до production        |
| **Риск**                | Ниже, так как есть человеческий контроль              | Выше, требуется высокая уверенность в тестах         |
| **Скорость**            | Высокая, но с задержкой на утверждение                | Максимальная, изменения попадают к пользователям за минуты |
| **Когда выбирать**      | Продукты, где критично ручное тестирование перед релизом; команды без полной автоматизации | SaaS-продукты, где важна скорость; высокая зрелость тестирования |
| **Пример**              | Релиз раз в неделю по кнопке                          | Каждый коммит в main автоматически уходит в прод      |

---

## Стратегии развёртывания

### 1. Rolling update (постепенное обновление)
- Старые экземпляры приложения заменяются новыми один за другим.
- Сервис остаётся доступным во время обновления.
- Минус: во время обновления работают одновременно две версии, нужно обеспечить совместимость.

### 2. Blue-Green (сине-зелёное развёртывание)
- Два идентичных окружения: Blue (текущее) и Green (новое).
- Трафик направляется на Blue. После развёртывания на Green и тестирования трафик переключается на Green.
- Мгновенный откат: переключить обратно на Blue.

### 3. Canary (канареечное развёртывание)
- Новая версия сначала получает небольшую часть трафика (например, 5%).
- При отсутствии ошибок доля увеличивается до 100%.
- Позволяет проверить изменения на реальных пользователях с минимальным риском.

### 4. Feature flags (флаги функциональности)
- Код новой фичи скрыт за флагом, который можно включить без нового развёртывания.
- Упрощает тестирование в продакшене и постепенное включение.
- Комбинируется с другими стратегиями.

---

## Примеры CD-пайплайнов

### Пример Continuous Delivery (GitHub Actions + ручное утверждение)

```yaml
name: CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v3
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          push: true
          tags: myapp:${{ github.sha }}

  deploy-staging:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to staging
        run: |
          curl -X POST https://staging.example.com/deploy \
            -H "Authorization: token ${{ secrets.DEPLOY_TOKEN }}" \
            -d '{"tag": "${{ github.sha }}"}'
      - name: Run smoke tests on staging
        run: ./smoke-tests.sh staging

  wait-for-approval:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://myapp.example.com
    steps:
      - name: Wait for manual approval
        run: echo "Waiting for approval..."

  deploy-production:
    needs: wait-for-approval
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production (blue-green)
        run: |
          curl -X POST https://api.example.com/deploy/production \
            -H "Authorization: token ${{ secrets.DEPLOY_TOKEN }}" \
            -d '{"tag": "${{ github.sha }}", "strategy": "blue-green"}'
```

### Пример Continuous Deployment (GitLab CI)

```yaml
stages:
  - build
  - deploy-staging
  - test-staging
  - deploy-production

variables:
  TAG: $CI_COMMIT_SHA

build:
  stage: build
  script:
    - docker build -t myapp:$TAG .
    - docker push myapp:$TAG

deploy-staging:
  stage: deploy-staging
  script:
    - kubectl set image deployment/myapp myapp=myapp:$TAG -n staging
    - kubectl rollout status deployment/myapp -n staging
  environment:
    name: staging
    url: https://staging.myapp.com

test-staging:
  stage: test-staging
  script:
    - ./smoke-tests.sh staging
    - ./integration-tests.sh staging

deploy-production:
  stage: deploy-production
  script:
    - kubectl set image deployment/myapp myapp=myapp:$TAG -n production
    - kubectl rollout status deployment/myapp -n production
    - ./smoke-tests.sh production
  environment:
    name: production
    url: https://myapp.com
  only:
    - main
```

---

## Схема CD

```
[CI pipeline] --> [Build artifact] --> [Artifact registry]
                                            |
                                            v
                                   [Deploy to staging]
                                            |
                                            v
                                   [Smoke tests on staging]
                                            |
                    (Continuous Delivery)   |   (Continuous Deployment)
                            v                v
                 [Manual approval?]    [Auto if tests pass]
                            \               |
                             v              v
                          [Deploy to production]
                                            |
                                            v
                              [Smoke tests on production]
                                            |
                                            v
                              [Monitor and alert]
```

Графическая схема (Mermaid):

```mermaid
graph TD
    A[CI Pipeline] --> B[Artifact]
    B --> C[Deploy to Staging]
    C --> D[Tests on Staging]
    D --> E{Quality Gates}
    E -->|Pass| F[Manual Approval?]
    F -->|Yes| G[Deploy to Production]
    F -->|No (CDep)| G
    G --> H[Smoke Tests on Prod]
    H --> I[Monitor]
    I --> J[Alert/Rollback if needed]
```

---

## Чем ограничивается CD

1. **Требует зрелого CI** — без качественного CI (автоматические тесты, быстрая обратная связь) CD невозможен.
2. **Не заменяет мониторинг** — даже при автоматическом деплое нужно следить за работой приложения.
3. **Может маскировать проблемы окружения** — если staging отличается от production, то успешный деплой на staging не гарантирует успех на production.
4. **Требует дисциплины команды** — feature flags, обратная совместимость, миграции БД без даунтайма — всё это нужно проектировать.
5. **Сложность отката** — при автоматическом деплое нужно продумывать механизм быстрого отката (rollback).
6. **Безопасность** — автоматический деплой требует тщательной защиты доступа к production.

---

## Антипаттерны CD

- **Развёртывание без тестов на staging** — сразу в production, риск высок.
- **Ручные действия, которые не автоматизированы** — например, изменение конфигов вручную на сервере.
- **Отсутствие мониторинга после деплоя** — можно пропустить проблемы.
- **Долгий пайплайн** — разработчики теряют фокус.
- **Игнорирование неудачного деплоя** — красный пайплайн должен быть исправлен немедленно.
- **Отсутствие документации по процессу** — новый член команды не понимает, как выкатывать изменения.

---

## Связь с CI и DevOps

- **CI** — фундамент. Без автоматических тестов и сборки невозможно безопасно доставлять изменения.
- **CD** — следующий шаг, автоматизирующий развёртывание.
- **DevOps** — культура, объединяющая разработку и эксплуатацию. CI/CD — ключевая практика DevOps.

---

## Инструменты CD

Многие инструменты покрывают и CI, и CD:

| Инструмент         | Роль в CD                                                                |
|--------------------|--------------------------------------------------------------------------|
| **Jenkins**        | Универсальный оркестратор, можно строить сложные пайплайны CD            |
| **GitLab CI**      | Встроенные окружения (environments), ручные действия, мониторинг деплоев |
| **GitHub Actions** | Поддержка окружений, ручное утверждение, развёртывание на облака         |
| **Spinnaker**      | Специализированная платформа для CD с поддержкой canary, blue-green      |
| **ArgoCD**         | CD для Kubernetes (GitOps — синхронизация Git-репозитория с кластером)   |
| **Flux**           | Ещё один GitOps-инструмент для Kubernetes                                |
| **Tekton**         | Kubernetes-нативный фреймворк для CI/CD                                  |
| **CircleCI**       | Облачный сервис с поддержкой оркестрации деплоев                         |
| **Octopus Deploy** | Специализированный инструмент для CD (.NET, но не только)                |

Выбор зависит от инфраструктуры (Kubernetes или нет), предпочтений команды и экосистемы.

---

## Заключение

CD — это естественное развитие CI, превращающее процесс доставки ПО в предсказуемый и автоматизированный конвейер. Переход к Continuous Delivery или Continuous Deployment требует:

- Высокого покрытия кода тестами.
- Стандартизации окружений.
- Автоматизации развёртывания.
- Культуры быстрого реагирования на сбои.

Начинать можно с Continuous Delivery: staging-окружение, ручное утверждение, но полностью автоматизированный процесс до него. Когда команда обретёт уверенность, можно переходить к Continuous Deployment.

Помните: цель CD — не просто автоматизация, а **снижение времени и риска доставки ценности пользователям**.

---

## Дополнительные материалы в репозитории
- [CI: подробное руководство](ci.md)
- [Инструменты CI/CD](ci_cd_tools.md) (если есть)
- [Стратегии развёртывания](deployment_strategies.md) (если есть)
- [GitOps с ArgoCD](argocd.md) (если есть)
- [Мониторинг после деплоя](../tools/monitoring.md)