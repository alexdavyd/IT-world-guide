## Что такое QUIC?

QUIC (произносится «квик», бэкроним от *Quick UDP Internet Connections*) — это сетевой протокол транспортного уровня, изначально разработанный компанией Google в 2012 году и стандартизированный IETF (Internet Engineering Task Force) в мае 2021 года как RFC 9000 . QUIC создавался как замена связки TCP+TLS+HTTP/2 для уменьшения задержек и повышения производительности веб-приложений .

## Проблема: почему потребовался новый протокол?

Чтобы понять ценность QUIC, нужно взглянуть на ограничения традиционного стека протоколов:

1. **TCP требует рукопожатия**. Для установки TCP-соединения нужно «тройное рукопожатие» (SYN, SYN-ACK, ACK) — один круг туда-обратно (1 RTT) .
2. **TLS добавляет ещё рукопожатия**. Для HTTPS поверх TCP нужно дополнительное рукопожатие TLS — ещё 1–2 RTT .
3. **HTTP/2 мультиплексирует, но TCP останавливает всё при потере**. Даже с мультиплексированием HTTP/2, если теряется один TCP-пакет, все потоки в этом соединении блокируются до повторной отправки потерянного пакета. Это называется **проблемой головы очереди (Head-of-Line Blocking)** .
4. **Смена сети убивает соединение**. TCP-соединение идентифицируется четвёркой (IP-адрес клиента, порт клиента, IP-адрес сервера, порт сервера). При переходе с Wi-Fi на мобильную сеть IP-адрес меняется — соединение разрывается, и всё нужно начинать заново .

## Как работает QUIC?

QUIC решает эти проблемы, работая поверх UDP (протокол пользовательских дейтаграмм), но добавляя поверх него все необходимые функции надёжности . Можно сказать, что QUIC — это «TCP, переработанный с учётом современных требований, работающий поверх UDP».

### Архитектурно QUIC:

- **Работает поверх UDP**, используя его как «трубу» для отправки пакетов .
- **Сам обеспечивает надёжность**, подтверждения получения (ACK), контроль перегрузок и коррекцию ошибок — то, что в TCP делается на уровне ядра ОС .
- **Встраивает TLS 1.3** непосредственно в протокол, делая шифрование обязательным и более эффективным .

## Ключевые особенности QUIC

### 1. Быстрая установка соединения (0-RTT и 1-RTT)

- **При первом соединении**: клиент и сервер обмениваются пакетами, которые одновременно выполняют и транспортное рукопожатие, и криптографическое (TLS). Это занимает всего **1 круг (1 RTT)** вместо 2–3 у TCP+TLS .
- **При повторном соединении**: если клиент уже общался с сервером, он может начать отправлять данные **немедленно (0 RTT)**, используя параметры прошлой сессии .

### 2. Мультиплексирование без блокировки головы очереди

QUIC разделяет соединение на множество независимых **потоков (streams)**. Если в одном потоке теряется пакет, это влияет **только на этот поток** — остальные продолжают передаваться без задержки . Это фундаментальное отличие от TCP, где потеря любого пакета останавливает все потоки в соединении.

Простая аналогия: TCP — это один длинный поезд, где при поломке одного вагона стоит весь состав. QUIC — несколько независимых грузовиков: если один сломался, остальные едут дальше .

### 3. Идентификаторы соединения (Connection ID) и миграция

QUIC идентифицирует соединение не по IP-адресам и портам, а по **уникальному идентификатору (Connection ID)**, который хранится в каждом пакете .

**Что это даёт**: пользователь может переключиться с Wi-Fi на мобильный интернет — IP-адрес меняется, но Connection ID остаётся прежним. Сервер понимает, что это продолжение того же соединения, и передача данных продолжается **без разрыва и повторного рукопожатия** . По данным тестов, время восстановления соединения при смене сети сокращается с 1.5–3 секунд (TCP) до 0.1–0.5 секунды (QUIC) .

### 4. Встроенное шифрование (TLS 1.3)

В QUIC шифрование **встроено на транспортном уровне**, а не надстроено сверху, как в случае TCP+TLS . Это даёт несколько преимуществ:
- Меньше служебных данных.
- Шифруется больше метаинформации (например, SNI — имя сервера) .
- Обеспечивается forward secrecy (совершенная прямая секретность) .

### 5. Гибкий контроль перегрузок

Алгоритмы управления перегрузкой реализованы **на уровне приложения, а не в ядре ОС** . Это позволяет:
- Обновлять алгоритмы без обновления операционной системы.
- Использовать разные алгоритмы для разных типов трафика (BBR для потокового видео, CUBIC для массовых загрузок).
- Динамически переключать алгоритмы в рантайме .

### 6. Прямое исправление ошибок (FEC — Forward Error Correction)

QUIC может отправлять избыточные данные, позволяющие восстановить потерянные пакеты без повторной отправки (хотя в стандартной реализации эта функция часто отключена) . Cloudflare в своих тестах показывала, что при 20% потерях пакетов соединение остаётся работоспособным благодаря FEC .

## QUIC и HTTP/3

QUIC — это транспортный протокол, а HTTP/3 — это версия HTTP, использующая QUIC вместо TCP .

- **HTTP/2** работает поверх TCP (+TLS).
- **HTTP/3** работает поверх QUIC (который сам работает поверх UDP).

HTTP/3 использует все преимущества QUIC: быстрый старт, отсутствие блокировки потоков, встроенное шифрование, миграцию соединений .

## Где используется QUIC сегодня

- **Браузеры**: Google Chrome, Microsoft Edge, Mozilla Firefox, Safari (начиная с macOS 14 и iOS 17) поддерживают QUIC/HTTP/3 .
- **Крупные интернет-компании**: Google (YouTube, Поиск), Meta (Facebook, Instagram), Cloudflare, Netflix активно используют QUIC для доставки контента .
- **Веб-серверы и CDN**: nginx (с модулем), LiteSpeed, Cloudflare CDN, AWS,阿里云 (Alibaba Cloud) поддерживают HTTP/3 .
- **Библиотеки реализации**:
    - Оригинальная реализация Google на C++ (в составе Chromium) .
    - MsQuic от Microsoft (на C) — используется в .NET и Windows .
    - quic-go на Go .
    - Реализации на Rust, Python и других языках.

## QUIC в контексте Instagram (связь с предыдущей темой)

В первой части статьи об архитектуре Instagram упоминалось, что компания использует **QUIC** и **HTTP/3** для глобальной балансировки трафика и доставки контента . Почему это важно для Instagram:

- **Миллионы мобильных пользователей** постоянно переключаются между Wi-Fi и сотовыми сетями. QUIC позволяет видеозвонкам в Direct, загрузке Stories и просмотру Reels продолжаться без обрыва при смене сети .
- **Высокая потеря пакетов в мобильных сетях** не убивает весь поток — если теряется пакет с частью видео в Reels, остальные потоки (например, загрузка аватарок) продолжают работать .
- **Быстрый старт** критичен для удержания пользователя — первая загрузка ленты происходит быстрее благодаря 0-RTT .

## Недостатки и ограничения QUIC

1. **UDP может блокироваться** — некоторые корпоративные файрволы и сети блокируют UDP-трафик, что требует механизмов отката к TCP .
2. **Сложность отладки** — из-за шифрования большего количества метаданных (включая SNI) сетевым администраторам и DPI-системам сложнее анализировать трафик .
3. **Нагрузка на CPU** — реализация сложной логики (контроль перегрузок, управление потоками) на уровне приложения, а не в ядре, может потребовать больше вычислительных ресурсов.
4. **Молодость экосистемы** — хотя QUIC уже стандартизирован, не все сетевые устройства и библиотеки его корректно поддерживают .

## Заключение

QUIC — это не просто «очередной протокол», а фундаментальный пересмотр того, как должен работать транспортный уровень в современном интернете. Он решает проблемы TCP, которые накапливались десятилетиями, и делает это с учётом реалий мобильного интернета, шифрования и высоконагруженных сервисов вроде Instagram.

Как сказано в одном из источников: «QUIC не простой заменяет TCP, а重构ает (переосмысливает)权力 границы (границы власти) в стеке протоколов — когда прикладной уровень получает контроль над транспортным, это меняет правила игры» .